<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finan√ßas Premium Pro + Agenda & Reset</title>

    <link rel="manifest" href="manifest.json">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="HM Finan Pro">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/552/552791.png">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdmZXRjaCcsIGV2ZW50ID0+IHsgfSk7')
            .catch(err => console.log("SW Error:", err));
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --apple-bg: #f5f5f7;
            --apple-card: #ffffff;
            --apple-text: #1d1d1f;
            --apple-dim: #86868b;
            --apple-blue: #0071e3;
            --apple-red: #ff3b30;
            --apple-green: #34c759;
            --sidebar-width: 280px;
        }

        * { box-sizing: border-box; transition: all 0.2s ease; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--apple-bg); color: var(--apple-text); margin: 0; padding: 0; overflow-x: hidden; }
        .container { width: 100%; max-width: 1100px; margin: auto; padding: 20px; padding-top: 70px; }

        /* --- SIDEBAR --- */
        #sidebar {
            position: fixed; left: -100%; top: 0;
            width: 85%; max-width: var(--sidebar-width); height: 100%;
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px);
            border-right: 1px solid rgba(0,0,0,0.1); z-index: 3000; padding: 40px 20px;
            box-shadow: 10px 0 30px rgba(0,0,0,0.1);
            display: flex; flex-direction: column;
        }
        #sidebar.open { left: 0; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2500; display: none; }
        .menu-btn { position: fixed; top: 15px; left: 15px; background: white; border: 1px solid rgba(0,0,0,0.1); cursor: pointer; z-index: 1001; padding: 12px 15px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); font-size: 1.2rem; }

        /* --- MODAL AGENDA --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 4000; display: none; padding: 20px; overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        @media (max-width: 768px) {
            .modal { top: 5%; border-radius: 25px 25px 0 0; }
            .agenda-split { grid-template-columns: 1fr !important; }
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: sticky; top: 0; background: white; z-index: 10; padding: 10px 0; }
        .calendar-grid-custom { display: grid; grid-template-columns: 30px repeat(7, 1fr); gap: 4px; }
        .cal-day { padding: 12px 5px; border: 1px solid #f0f0f0; text-align: center; border-radius: 10px; cursor: pointer; font-size: 12px; font-weight: 500; position: relative; }
        .cal-day.active { background: var(--apple-blue) !important; color: white !important; border-color: var(--apple-blue) !important; }
        
        .cal-day.has-task { border: 2px solid var(--apple-green); }
        .slot-filled { background: #f0fff4 !important; border: 1.5px solid var(--apple-green) !important; }
        .slot-hidden { display: none !important; }

        .btn-week-sel { background: #f8f9fa; border: none; font-size: 9px; color: var(--apple-dim); }

        /* --- UI FINAN√áAS --- */
        .summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 30px; }
        .summary-card { background: var(--apple-card); padding: 15px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); }
        .summary-card span { font-size: 10px; color: var(--apple-dim); font-weight: 700; text-transform: uppercase; }
        .summary-card div { font-size: 18px; font-weight: 700; margin-top: 5px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .card { background: var(--apple-card); border-radius: 24px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
        .input-box { background: #f5f5f7; padding: 15px; border-radius: 18px; display: flex; flex-direction: column; gap: 10px; }
        input { border: 1px solid #e5e5e7; background: white; padding: 14px; border-radius: 12px; outline: none; font-size: 16px; width: 100%; }
        .add-btn { background: var(--apple-text); color: white; border: none; min-height: 48px; padding: 0 20px; border-radius: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        .history { max-height: 160px; overflow-y: auto; margin-bottom: 15px; border-top: 1px solid #f5f5f7; }
        .item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f5f5f7; font-size: 14px; align-items: center; }
        
        .del-btn { background: none; border: none; color: var(--apple-dim); cursor: pointer; font-size: 14px; margin-left: 8px; font-weight: bold; padding: 4px; }
        .del-btn:hover { color: var(--apple-red); }

        .charts-section { background: var(--apple-card); padding: 20px; border-radius: 24px; box-shadow: 0 4px 25px rgba(0,0,0,0.05); margin-bottom: 40px; }
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px; }
        @media (max-width: 768px) { .summary { grid-template-columns: 1fr; } .charts-grid { grid-template-columns: 1fr !important; } }
    </style>
</head>
<body>

    <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
    <div class="overlay" id="overlay" onclick="toggleMenu()"></div>

    <div id="sidebar">
        <h2 style="margin-top:0; font-size: 20px;">Menu</h2>
        <button class="add-btn" style="width:100%; margin-bottom:25px; background: var(--apple-blue);" onclick="openModal('agendaModal')">üìÖ AGENDA</button>
        <p style="font-size: 11px; color: var(--apple-dim); font-weight: bold; margin-bottom: 10px;">DADOS</p>
        <button class="add-btn" style="width:100%; margin-bottom:12px; background:#e8e8ed; color:#1d1d1f" onclick="exportBackup()">Exportar Backup</button>
        <button class="add-btn" style="width:100%; background:#e8e8ed; color:#1d1d1f" onclick="document.getElementById('fileInput').click()">Importar Backup</button>
        <input type="file" id="fileInput" style="display:none" onchange="importBackup(event)">
        <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid #eee;">
            <button class="add-btn" style="width:100%; background:#fff5f5; color:var(--apple-red); border: 1px solid #ffc9c9;" onclick="factoryReset()">‚ö†Ô∏è Limpar Tudo</button>
        </div>
    </div>

    <div id="agendaModal" class="modal">
        <div class="modal-header">
            <h2 style="margin:0">Agenda</h2>
            <button class="add-btn" style="min-height:35px; background:#f5f5f7; color:black" onclick="closeModal('agendaModal')">Fechar</button>
        </div>
        <div class="agenda-split" style="display: grid; grid-template-columns: 1fr 1.2fr; gap: 20px;">
            <div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
                    <button class="add-btn" style="min-height:40px; background:#f5f5f7; color:black" onclick="changeMonth(-1)">‚óÄ</button>
                    <h3 id="titleAgenda" style="font-size: 16px;"></h3>
                    <button class="add-btn" style="min-height:40px; background:#f5f5f7; color:black" onclick="changeMonth(1)">‚ñ∂</button>
                </div>
                <div id="gridAgenda" class="calendar-grid-custom"></div>
            </div>
            <div>
                <div id="agendaHeader" style="display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 15px; border: 1px solid var(--apple-green); border-radius: 12px; padding: 10px;">
                    <h4 id="selectedDateTitle" style="margin:0; font-size: 14px;"></h4>
                    <span id="taskCounter" style="color: var(--apple-green); font-weight: bold; font-size: 14px;">Hor√°rios: 0</span>
                    <button id="toggleSummaryBtn" class="add-btn" style="min-height:30px; padding: 0 10px; font-size: 12px; background: var(--apple-green);" onclick="toggleAgendaView()">Resumo do Dia</button>
                </div>
                <div id="timeSlots" style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                    <p style="color:var(--apple-dim); text-align:center">Toque em um dia no calend√°rio</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <header style="text-align:center; margin-bottom:30px">
            <input type="month" id="monthPicker" class="add-btn" style="background:#fff; color:black; width: 200px; margin: auto; border: 1px solid #ddd;" onchange="loadMonth()">
        </header>

        <div class="summary">
            <div class="summary-card"><span>üí∞ Entradas</span><div id="displayIncome" style="color: var(--apple-green);">R$ 0,00</div></div>
            <div class="summary-card"><span>üìâ Gastos</span><div id="displaySpent" style="color: var(--apple-red);">R$ 0,00</div></div>
            <div class="summary-card"><span>‚öñÔ∏è Saldo</span><div id="displayBalance">R$ 0,00</div></div>
        </div>

        <div class="grid">
            <div class="card" style="border: 2px solid var(--apple-green); background: #f6fff8;">
                <div class="card-header"><h3>üíµ Renda</h3></div>
                <div class="history" id="incomeHistory"></div>
                <div class="input-box">
                    <input type="text" id="incomeDesc" placeholder="Descri√ß√£o">
                    <input type="number" id="incomeVal" placeholder="R$ 0,00" inputmode="decimal">
                    <button class="add-btn" style="background: var(--apple-green)" onclick="addIncome()">Adicionar</button>
                </div>
            </div>
            <div id="categoriesContainer" style="display:contents"></div>
        </div>

        <div class="charts-section">
            <div class="charts-grid">
                <div><canvas id="pizzaChart"></canvas></div>
                <div><canvas id="barChart"></canvas></div>
            </div>
        </div>
    </div>

    <script>
        const CATEGORIES = [
            { id: 'hab', name: 'Habita√ß√£o', icon: 'üè†' },
            { id: 'ali', name: 'Alimenta√ß√£o', icon: 'üçé' },
            { id: 'tra', name: 'Transporte', icon: 'üöó' },
            { id: 'laz', name: 'Lazer', icon: 'üé¨' },
            { id: 'sau', name: 'Sa√∫de', icon: '‚öïÔ∏è' },
            { id: 'out', name: 'Outros', icon: 'üì¶' }
        ];

        let db = JSON.parse(localStorage.getItem(`fin_pro_v5_ag`)) || { agenda: {} };
        let currentCalDate = new Date();
        let pizzaChart;
        let isSummaryMode = false;
        let currentSelectedDate = "";

        function toggleMenu() {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('overlay');
            sb.classList.toggle('open');
            ov.style.display = sb.classList.contains('open') ? 'block' : 'none';
        }

        function openModal(id) { 
            document.getElementById(id).style.display = 'block'; 
            if(id === 'agendaModal') {
                const hoje = new Date();
                currentCalDate = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                renderCalendar();
                const dsHoje = `${hoje.getFullYear()}-${String(hoje.getMonth()+1).padStart(2,'0')}-${String(hoje.getDate()).padStart(2,'0')}`;
                renderTimeSlots(dsHoje);
            } 
            toggleMenu(); 
        }
        
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function changeMonth(s) { currentCalDate.setMonth(currentCalDate.getMonth() + s); renderCalendar(); }
        
        function renderCalendar() {
            const grid = document.getElementById('gridAgenda');
            const title = document.getElementById('titleAgenda');
            grid.innerHTML = `<div class="cal-day btn-week-sel"></div><div class="cal-day btn-week-sel">D</div><div class="cal-day btn-week-sel">S</div><div class="cal-day btn-week-sel">T</div><div class="cal-day btn-week-sel">Q</div><div class="cal-day btn-week-sel">Q</div><div class="cal-day btn-week-sel">S</div><div class="cal-day btn-week-sel">S</div>`;
            const m = currentCalDate.getMonth(), y = currentCalDate.getFullYear();
            title.innerText = new Intl.DateTimeFormat('pt-BR', {month:'long', year:'numeric'}).format(currentCalDate);
            const first = new Date(y, m, 1).getDay(), last = new Date(y, m + 1, 0).getDate();
            let dCount = 1;
            for(let r=0; r<6; r++) {
                if(dCount > last) break;
                grid.innerHTML += `<div class="cal-day btn-week-sel"></div>`;
                for(let c=0; c<7; c++) {
                    if((r===0 && c<first) || dCount > last) grid.innerHTML += `<div></div>`;
                    else {
                        const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(dCount).padStart(2,'0')}`;
                        let hasTaskClass = "";
                        if(db.agenda[ds]) {
                            const values = Object.values(db.agenda[ds]);
                            if(values.some(v => v && v.trim() !== "")) hasTaskClass = "has-task";
                        }
                        grid.innerHTML += `<div class="cal-day ${hasTaskClass}" data-date="${ds}" onclick="renderTimeSlots('${ds}')">${dCount}</div>`;
                        dCount++;
                    }
                }
            }
        }

        function toggleAgendaView() {
            isSummaryMode = !isSummaryMode;
            const btn = document.getElementById('toggleSummaryBtn');
            btn.innerText = isSummaryMode ? "Ver Todos" : "Resumo do Dia";
            renderTimeSlots(currentSelectedDate);
        }

        function renderTimeSlots(ds) {
            currentSelectedDate = ds;
            document.querySelectorAll('.cal-day').forEach(el => el.classList.remove('active'));
            const selectedEl = document.querySelector(`.cal-day[data-date="${ds}"]`);
            if(selectedEl) selectedEl.classList.add('active');

            document.getElementById('selectedDateTitle').innerText = ds.split('-').reverse().join('/');
            const container = document.getElementById('timeSlots');
            container.innerHTML = ""; 
            if(!db.agenda[ds]) db.agenda[ds] = {};
            
            let count = 0;
            for(let h=8; h<=20; h++) {
                [":00", ":30"].forEach(min => {
                    const t = h.toString().padStart(2,'0') + min;
                    const val = db.agenda[ds][t] || '';
                    const isFilled = (val && val.trim() !== "");
                    if(isFilled) count++;

                    const hideClass = (isSummaryMode && !isFilled) ? 'slot-hidden' : '';

                    container.innerHTML += `
                    <div class="slot-container ${isFilled ? 'slot-filled' : ''} ${hideClass}" style="display:flex; align-items:center; gap:10px; background:#fff; padding:8px; border-radius:12px; border:1px solid #f1f1f1">
                        <span style="font-size:12px; font-weight:bold; min-width:45px">${t}</span>
                        <input type="text" value="${val}" 
                            onchange="updateTask('${ds}', '${t}', this)" 
                            placeholder="Livre..." 
                            style="border:none !important; background:transparent">
                    </div>`;
                });
            }
            document.getElementById('taskCounter').innerText = "Hor√°rios: " + count;
        }

        function updateTask(ds, t, inputEl) {
            db.agenda[ds][t] = inputEl.value;
            saveDb();
            renderCalendar();
            renderTimeSlots(ds);
        }

        function loadMonth() {
            const m = document.getElementById('monthPicker').value;
            if (!db[m]) db[m] = { incomeItems: [], expenses: {} };
            render();
        }

        function addIncome() {
            const m = document.getElementById('monthPicker').value;
            const descEl = document.getElementById('incomeDesc');
            const valEl = document.getElementById('incomeVal');
            const v = parseFloat(valEl.value) || 0;
            if(v > 0) { 
                db[m].incomeItems.push({ desc: descEl.value || "Renda", val: v, id: Date.now() }); 
                descEl.value = ""; valEl.value = "";
                saveAndRender(); 
            }
        }

        function addExpense(catId) {
            const m = document.getElementById('monthPicker').value;
            const descEl = document.getElementById(`d-${catId}`);
            const valEl = document.getElementById(`v-${catId}`);
            const v = parseFloat(valEl.value) || 0;
            if(v > 0) { 
                if(!db[m].expenses[catId]) db[m].expenses[catId] = []; 
                db[m].expenses[catId].push({ desc: descEl.value || "Gasto", val: v, id: Date.now() }); 
                descEl.value = ""; valEl.value = "";
                saveAndRender(); 
            }
        }

        function deleteIncome(index) {
            if (confirm("Tem certeza que deseja apagar este lan√ßamento?")) {
                const m = document.getElementById('monthPicker').value;
                db[m].incomeItems.splice(index, 1);
                saveAndRender();
            }
        }
        function deleteExpense(catId, index) {
            if (confirm("Tem certeza que deseja apagar este lan√ßamento?")) {
                const m = document.getElementById('monthPicker').value;
                db[m].expenses[catId].splice(index, 1);
                saveAndRender();
            }
        }

        function saveDb() { localStorage.setItem(`fin_pro_v5_ag`, JSON.stringify(db)); }
        function saveAndRender() { saveDb(); render(); }

        function render() {
            const m = document.getElementById('monthPicker').value;
            const data = db[m] || { incomeItems: [], expenses: {} };
            
            document.getElementById('incomeHistory').innerHTML = (data.incomeItems || []).map((i, index) => 
                `<div class="item">
                    <span>${i.desc}</span>
                    <span>R$ ${i.val.toFixed(2)} <button class="del-btn" onclick="deleteIncome(${index})">‚úï</button></span>
                </div>`
            ).join('');

            const container = document.getElementById('categoriesContainer'); container.innerHTML = "";
            let catTotals = [];
            CATEGORIES.forEach(cat => {
                const list = data.expenses[cat.id] || []; 
                const total = list.reduce((a, b) => a + b.val, 0); 
                catTotals.push(total);
                
                container.innerHTML += `
                <div class="card">
                    <div class="card-header"><h3>${cat.icon} ${cat.name}</h3><span class="cat-total">R$ ${total.toFixed(2)}</span></div>
                    <div class="history">${list.map((e, index) => 
                        `<div class="item">
                            <span>${e.desc}</span>
                            <span>R$ ${e.val.toFixed(2)} <button class="del-btn" onclick="deleteExpense('${cat.id}', ${index})">‚úï</button></span>
                        </div>`).join('')}
                    </div>
                    <div class="input-box">
                        <input type="text" id="d-${cat.id}" placeholder="O que?">
                        <input type="number" id="v-${cat.id}" placeholder="R$" inputmode="decimal">
                        <button class="add-btn" onclick="addExpense('${cat.id}')">Lan√ßar</button>
                    </div>
                </div>`;
            });

            const ti = (data.incomeItems || []).reduce((a, b) => a + b.val, 0); 
            const te = catTotals.reduce((a, b) => a + b, 0);
            document.getElementById('displayIncome').innerText = `R$ ${ti.toFixed(2)}`;
            document.getElementById('displaySpent').innerText = `R$ ${te.toFixed(2)}`;
            document.getElementById('displayBalance').innerText = `R$ ${(ti - te).toFixed(2)}`;
            updateCharts(catTotals);
        }

        function updateCharts(totals) {
            const colors = ['#0071e3', '#34c759', '#ff9500', '#af52de', '#ff3b30', '#5856d6'];
            if (pizzaChart) pizzaChart.destroy();
            pizzaChart = new Chart(document.getElementById('pizzaChart'), { type: 'doughnut', data: { labels: CATEGORIES.map(c=>c.name), datasets: [{ data: totals, backgroundColor: colors }] }, options: { plugins: { legend: { position: 'bottom' } } } });
        }

        function exportBackup() { const blob = new Blob([JSON.stringify(db)], {type: "application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "backup_completo.json"; a.click(); }
        function importBackup(e) { const reader = new FileReader(); reader.onload = (ev) => { db = JSON.parse(ev.target.result); saveAndRender(); alert("Backup restaurado!"); }; reader.readAsText(e.target.files[0]); }

        function factoryReset() {
            if (confirm("‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o apagar√° permanentemente TODAS as suas finan√ßas e agendamentos.\n\nDeseja continuar?")) {
                const senha = prompt("Digite a senha de seguran√ßa:");
                if (senha === "121991") {
                    localStorage.removeItem('fin_pro_v5_ag');
                    alert("Sistema redefinido com sucesso.");
                    location.reload();
                } else if (senha !== null) {
                    alert("Senha incorreta.");
                }
            }
        }

        window.onload = () => {
            const now = new Date();
            document.getElementById('monthPicker').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            loadMonth();
        };
    </script>
</body>
</html>